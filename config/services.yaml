# Learn more about services, parameters and containers at
# https://symfony.com/doc/current/service_container.html
parameters:
#    parameter_name: value

    password_consoupload: MOTDEPASSE
    mailer_transport: smtp
    mailer_host: 127.0.0.1
    mailer_user: null
    mailer_password: null
    secret: ThisTokenIsNotSoSecretChangeIt
    mesoc: CALMIP
    mesoc_web: 'https://www.calmip.univ-toulouse.fr'
    mesoc_cgu: 'https://www.calmip.univ-toulouse.fr/cgu'
    mesoc_visu: 'https://www.calmip.univ-toulouse.fr/spip/spip.php?article463'
    mesoc_attrib: 'https://www.calmip.univ-toulouse.fr/spip/spip.php?article19'
    mesoc_merci: 'https://www.calmip.univ-toulouse.fr/spip/spip.php?article337'
    mesoc_address: 'CALMIP - Espace Clément Ader - 3 rue Caroline Aigle - 31400 TOULOUSE'
    attrib_seuil_a: 600000
    recup_attrib_seuil: 300000
    recup_conso_seuil: 30
    recup_attrib_quant: 50
    recup_printemps_d: 5
    recup_printemps_f: 8
    recup_automne_d: '09'
    recup_automne_f: 10
    conso_seuil_1: 70
    conso_seuil_2: 90
    max_fig_width: 800
    max_fig_height: 400
    max_page_nb: 5
    noconso: false
    max_rall: 4
    prj_prefix:
        1: P
        2: T
    ressources_conso_group:
        1:
            type: calcul
            ress: 'cpu,gpu'
            nom: 'Heures normalisées'
            unite: h
        2:
            type: stockage
            ress: work_space
            nom: 'Espace work'
            unite: Tio
        3:
            type: stockage
            ress: home_space
            nom: Home
            unite: Gio
    ressources_conso_user:
        1:
            type: calcul
            ress: 'cpu,gpu'
            nom: 'Heures normalisées'
            unite: h
        2:
            type: stockage
            ress: work_space
            nom: 'Espace work'
            unite: Tio
        3:
            type: stockage
            ress: home_space
            nom: Home
            unite: Gio
        4:
            type: stockage
            ress: tmpdir_space
            nom: tmpdir
            unite: Gio
    max_expertises_nb: 1
    commentaires_experts_d: 5
    commentaires_experts_f: 3
    signature_directory: '%kernel.root_dir%/../data/fiches'
    rapport_directory: '%kernel.root_dir%/../data/rapports'
    fig_directory: '%kernel.root_dir%/../data/figures'
    dfct_directory: '%kernel.root_dir%/../data/dfct'
    heures_projet_test: 50000
    mailadmin: admin.calmip@univ-toulouse.fr
    mailfrom: ne-pas-repondre@calmip.univ-toulouse.fr
    old_journal: 5
    maildevt: devt1@exemple.com
    IDPprod:
        CNRS: 'https://janus.cnrs.fr/idp'
        'Université de Toulouse 3 Paul Sabatier': 'https://shibboleth.ups-tlse.fr/idp/shibboleth'
        'Comptes CRU': 'urn:mace:cru.fr:federation:sac'
        'INPT - Institut National Polytechnique de Toulouse': 'https://idp.inp-toulouse.fr/idp/shibboleth'
        AUTRE: WAYF

services:
     _defaults:
          public: true
#          autowire: true
#          autoconfigure: true
     
     # Tous les controleurs sont des services, ils peuvent utiliser la dependency injection     
     App\Controller\:
       resource: '../src/Controller/*'
       tags: [controller.service_arguments]

#    service_name:
#        class: App\Directory\ClassName
#        arguments: ["@another_service_name", "plain_value", "%parameter_name%"]
     # A JETER
     #app.init_controller:
     #  class: App\Controller\InitController
     #  arguments: ["@doctrine.orm.entity_manager","@kernel"]
       
     # Informations générales (bas de page, haut de page)
     app.gramc.ServiceInfos:
       class: App\GramcServices\ServiceInfos
       arguments: ["@app.gramc.date","@doctrine.orm.entity_manager"]
       
     # cf https://stackoverflow.com/questions/47613979/symfony-3-4-0-could-not-find-any-fixture-services-to-load
     # makes classes in src/AppBundle/DataFixtures available to be used as services
     # and have a tag that allows actions to type-hint services
     App\DataFixtures\:
         resource: '../src/DataFixtures'
         tags: ['doctrine.fixture.orm']
         
     App\DataFixtures\ORM\ProjetsVersionDerniereActive:
         arguments: ["@app.gramc.ServiceProjets"]
         tags: ['doctrine.fixture.orm']

#     app.gramc.fixture:
#      class: App\DataFixtures\ORM\Essais
#      arguments: ["app.gramc.ServiceSessions"]

     app.gramc_user_provider:
       class: App\Security\User\GramcUserProvider
       arguments: ["@doctrine.orm.entity_manager"]
       
     app.user_checker:
       class: App\Security\User\UserChecker
       arguments: ["@security.authorization_checker","@security.token_storage","@session","@app.gramc.ServiceJournal","@doctrine.orm.entity_manager"]

     app.test_user_provider:
       class: App\Security\User\TestUserProvider

     app.exception_listener:
        class: App\EventListener\ExceptionListener
        arguments: ["%kernel.debug%", '@router','@logger',"@app.gramc.ServiceJournal",'@session',"@doctrine.orm.entity_manager"]
        tags:
            - { name: kernel.event_listener, event: kernel.exception }

     # Evenements Doctrine lorsqu'on met à jour une version
     App\EventListener\VersionStamp:
        arguments: ["@security.token_storage"]
        tags:
            - # these are the options required to define the entity listener
              name: 'doctrine.orm.entity_listener'
              event: 'preUpdate'
              entity: 'App\Entity\Version'

     App\EventListener\ProjetDerniereVersion:
        arguments: ["@app.gramc.ServiceProjets", "@doctrine.orm.entity_manager"]
        tags:
            - # these are the options required to define the entity listener
              name: 'doctrine.orm.entity_listener'
              event: 'postPersist'
              entity: 'App\Entity\Version'
            - name: 'doctrine.orm.entity_listener'
              event: 'postRemove'
              entity: 'App\Entity\Version'
            - name: 'doctrine.orm.entity_listener'
              event: 'postUpdate'
              entity: 'App\Entity\Version'

     # SERVICES GRAMC
     #app.gramc_date:
     #   class: App\Utils\GramcDateWrapper
     #   arguments: ['@kernel']

     # Paramètres dans la base de données
     app.gramc.param:
        class: App\GramcServices\ServiceParam
        arguments: ["@doctrine.orm.entity_manager"]
        
     # GramcDateTime et GramcDate
     #app.gramc.datetime:
     #   class: App\GramcServices\GramcDateTime:
     #   arguments: ["@app.gramc.param", "@doctrine.orm.entity_manager"]

     app.gramc.date:
        class: App\GramcServices\GramcDate
        arguments: ["%recup_printemps_d%","%recup_printemps_f%",
                    "%recup_automne_d%",  "%recup_automne_f%",
                    "@app.gramc.param", "@doctrine.orm.entity_manager"]

     # A VIRER ASAP   
     app.initialize:
        class: App\Utils\AppBundleInitialize
        arguments: ['@kernel']

     # Données de facturation 
     app.gramc_DonneesFacturation:
        class: App\GramcServices\DonneesFacturation
        arguments: ["%dfct_directory%","@app.gramc.ServiceProjets","@app.gramc.ServiceJournal","@doctrine.orm.entity_manager"]
     
     # Graphiques de consommation
     app.gramc.graf_calcul:
        class: App\GramcServices\GramcGraf\Calcul
        arguments: ['ressources_conso_group','ressources_conso_user',"@app.gramc.ServiceJournal"]
     
     app.gramc.graf_stockage:
        class: App\GramcServices\GramcGraf\Stockage
        arguments: ['ressources_conso_group','ressources_conso_user',"@app.gramc.ServiceJournal"]

     app.gramc.graf_calcultous:
        class: App\GramcServices\GramcGraf\CalculTous
        arguments: ['ressources_conso_group','ressources_conso_user',"@app.gramc.ServiceJournal"]
     
     # Sessions
     app.gramc.ServiceSessions:
        class: App\GramcServices\ServiceSessions
        arguments: ['recup_attrib_seuil','recup_conso_seuil','recup_attrib_quant',"@app.gramc.date","@form.factory","@doctrine.orm.entity_manager"]
 
     # Projets
     app.gramc.ServiceProjets:
        class: App\GramcServices\ServiceProjets
        arguments: ["%prj_prefix%",
                    "%ressources_conso_group%",
                    "%signature_directory%",
                    "%rapport_directory%",
                    "%fig_directory%",
                    "%dfct_directory%",
                    "@app.gramc.date",
                    "@app.gramc.ServiceVersions",
                    "@app.gramc.ServiceSessions",
                    "@app.gramc.ServiceJournal",
                    "@logger", 
                    "@security.authorization_checker",
                    "@security.token_storage",
                    "@doctrine.orm.entity_manager"]
     
     # Versions
     app.gramc.ServiceVersions:
        class: App\GramcServices\ServiceVersions
        arguments: [ '%attrib_seuil_a%', "%prj_prefix%", "%fig_directory%", "%signature_directory%", "@app.gramc.ServiceJournal", "@doctrine.orm.entity_manager"]
        
     # Menus
     app.gramc.ServiceMenus:
        class: App\GramcServices\ServiceMenus
        arguments: [ "%max_rall%",
                     "@app.gramc.ServiceVersions",
                     "@app.gramc.ServiceProjets",
                     "@app.gramc.ServiceJournal",
                     "@app.gramc.SessionWorkflow", 
                     "@app.gramc.date", 
                     "@validator",
                     "@app.gramc.ServiceSessions",
                     "@security.token_storage",
                     "@security.authorization_checker",
                     "@doctrine.orm.entity_manager" ]
        
     # Notifications
     app.gramc.ServiceNotifications:
        class: App\GramcServices\ServiceNotifications
        arguments: [ "%mailfrom%",
                     "@twig",
                     "@security.token_storage",
                     "@mailer",
                     "@app.gramc.ServiceJournal",
                     "@doctrine.orm.entity_manager"]

     # Experts
     app.gramc.ServiceExperts:
        class: App\GramcServices\ServiceExperts\ServiceExperts
        arguments: [ "%max_expertises_nb%", "@form.factory", "@app.gramc.ServiceNotifications", "@app.gramc.ServiceJournal", "@doctrine.orm.entity_manager"]
     app.gramc.ServiceExpertsRallonge:
        class: App\GramcServices\ServiceExperts\ServiceExpertsRallonge
        arguments: [ "%max_expertises_nb%", "@form.factory", "@app.gramc.ServiceNotifications", "@app.gramc.ServiceJournal", "@doctrine.orm.entity_manager"]

     app.gramc.PropExperts1:
        class: App\GramcServices\PropositionExperts\PropositionExpertsType1
        arguments: [ "@app.gramc.ServiceExperts", "@app.gramc.ServiceJournal", "@doctrine.orm.entity_manager"]
     app.gramc.PropExperts2:
        class: App\GramcServices\PropositionExperts\PropositionExpertsType2
        arguments: [ "@app.gramc.ServiceExperts", "@app.gramc.ServiceJournal", "@doctrine.orm.entity_manager"]
        
     # Workflow
     app.gramc.RallongeWorkflow:
        class: App\GramcServices\Workflow\Rallonge\RallongeWorkflow
        arguments: [ "@app.gramc.ServiceNotifications","@app.gramc.ServiceJournal","@app.gramc.ServiceSessions","@doctrine.orm.entity_manager"]
     app.gramc.VersionWorkflow:
        class: App\GramcServices\Workflow\Version\VersionWorkflow
        arguments: [ "@app.gramc.ServiceNotifications","@app.gramc.ServiceJournal","@app.gramc.ServiceSessions","@doctrine.orm.entity_manager"]
     app.gramc.ProjetWorkflow:
        class: App\GramcServices\Workflow\Projet\ProjetWorkflow
        arguments: [ "@app.gramc.ServiceNotifications","@app.gramc.ServiceJournal","@app.gramc.ServiceSessions","@doctrine.orm.entity_manager"]
     app.gramc.SessionWorkflow:
        class: App\GramcServices\Workflow\Session\SessionWorkflow
        arguments: [ "@app.gramc.ServiceNotifications","@app.gramc.ServiceJournal","@app.gramc.ServiceSessions","@doctrine.orm.entity_manager"]
        
     # Journal
     app.gramc.ServiceJournal:
        class: App\GramcServices\ServiceJournal
        arguments: [ "@request_stack",
                     "@session",
                     "@logger",
                     "@security.helper",
                     "@security.authorization_checker",
                     "@doctrine.orm.entity_manager"]

     # Formulaires, validateurs
     app.gramc.thematiquetype:
        class: App\Form\ThematiqueType
        arguments: ["@doctrine.orm.entity_manager"]
        tags: ["form.type"]

     app.gramc.metathematiquetype:
        class: App\Form\MetaThematiqueType
        arguments: ["@doctrine.orm.entity_manager"]
        tags: ["form.type"]

     app.gramc.rattachementtype:
        class: App\Form\RattachementType
        arguments: ["@doctrine.orm.entity_manager"]
        tags: ["form.type"]

     app.gramc.pagesnumbervalidator:
        class: App\Validator\Constraints\PagesNumberValidator
        arguments: [ "%max_page_nb%", "@app.gramc.ServiceJournal" ]
        tags: ["validator.constraint_validator" ]
        
     app.gramc.publicationtype:
        class: App\Form\PublicationType
        arguments: ["@app.gramc.date"]
        tags: ["form.type"]

     app.gramc.sessiontype:
        class: App\Form\SessionType
        arguments: ["@app.gramc.date","@doctrine.orm.entity_manager"]
        tags: ["form.type"]
